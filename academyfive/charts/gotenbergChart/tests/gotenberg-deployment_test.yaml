suite: gotenbergChart - Gotenberg Deployment
templates:
  - gotenberg-deployment.yaml
tests:
  - it: should be a deployment and include values-file properly
    set:
      enabled: true
      deployment.image: gotenberg/gotenberg
      deployment.versionTag: 8.13
      deployment.replicas: 3
      deployment.imagePullSecrets: "my-registry-secret"
      deployment.resources:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1Gi
      envData:
        TZ: "Europe/Berlin"
        TEST_VAR: "test-value"
    asserts:
      - isKind:
          of: Deployment
      - matchRegex:
          path: metadata.name
          pattern: gotenberg-deployment
      - equal:
          path: spec.replicas
          value: 3
      - matchRegex:
          path: spec.template.metadata.labels.app
          pattern: gotenberg-app
      - matchRegex:
          path: spec.template.spec.containers[0].name
          pattern: gotenberg
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: gotenberg/gotenberg:8.13
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 500m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 512Mi
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 1000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 1Gi
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TZ
            value: "Europe/Berlin"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEST_VAR
            value: "test-value"
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: my-registry-secret

  - it: should handle empty resources properly
    set:
      enabled: true
      deployment.resources: {}
    asserts:
      - isKind:
          of: Deployment
      - isNullOrEmpty:
          path: spec.template.spec.containers[0].resources
      - isNullOrEmpty:
          path: spec.template.spec.containers[0].resources
