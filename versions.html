<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Helm Repo – Versionen</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 6px; }
    .sub { color: #555; margin-bottom: 14px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; max-width: 920px; }
    .muted { color: #666; font-size: 13px; }
    .error { color: #b00020; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f2f2f2; font-size: 12px; }
    .pill-strong { font-weight: 650; }
    .summary { display:flex; gap:10px; flex-wrap:wrap; margin: 12px 0 14px; }
    .summaryBox { border: 1px solid #eee; border-radius: 14px; padding: 10px 12px; background: #fafafa; min-width: 260px; flex: 1; }
    .summaryTitle { font-size: 12px; color: #666; margin-bottom: 6px; }
    .summaryValue { font-size: 14px; font-weight: 700; }

    input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #ddd; max-width: 520px; }

    .versionsBox { margin-top: 10px; border: 1px solid #eee; border-radius: 12px; padding: 8px 10px; max-height: 420px; overflow: auto; background: #fff; }
    .verLine { padding: 7px 0; border-bottom: 1px dashed #f0f0f0; display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; }
    .verLine:last-child { border-bottom: none; }
    .verMeta { color:#666; font-size: 12px; }

    .btn { border:1px solid #ddd; background:#fff; border-radius: 12px; padding: 10px 12px; cursor:pointer; }
    .btn:hover { background:#fafafa; }

    .toprow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }

    .stamp { margin-top: 10px; color:#777; font-size:12px; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
  <h1>Verfügbare Versionen</h1>
  <div class="sub">Einfacher Überblick – ohne technische Details.</div>

  <div class="card">
    <div class="toprow">
      <div>
        <div class="muted">Quelle: <span class="pill" id="src">https://simovative.github.io/onPremise-Helm/index.yaml</span></div>
        <div class="muted">Stand: <span id="asof">—</span></div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="btn" id="reload">Neu laden</button>
      </div>
    </div>

    <div class="summary">
      <div class="summaryBox">
        <div class="summaryTitle">Latest (stable)</div>
        <div class="summaryValue" id="latestStable">—</div>
        <div class="muted" id="latestStableMeta"></div>
      </div>
      <div class="summaryBox">
        <div class="summaryTitle">Latest (any)</div>
        <div class="summaryValue" id="latestAny">—</div>
        <div class="muted" id="latestAnyMeta"></div>
      </div>
    </div>

    <div id="status" class="muted">Lade Daten…</div>

    <div style="margin-top:12px;">
      <input id="q" type="text" placeholder="In Versionen suchen (z. B. 18.03 oder stable)…" disabled />
      <div class="versionsBox" id="list" style="display:none;"></div>
    </div>

    <div class="stamp">Seiten-Version: <strong>2026-01-13-auto-1</strong></div>
  </div>

<script>
(function () {
  const BASE_INDEX_URL = "https://simovative.github.io/onPremise-Helm/index.yaml";
  const PREFERRED_CHART = "academyfive"; // falls vorhanden; sonst wird der einzige/erste Chart genommen

  const status = (msg, isErr=false) => {
    const el = document.getElementById("status");
    el.textContent = msg;
    el.className = isErr ? "error" : "muted";
  };

  const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));

  // Stable: appVersion enthält "stable" (z.B. V18.03.9-stable)
  function isStable(v) {
    const av = String(v?.appVersion || "").toLowerCase();
    return av.includes("stable");
  }

  function dateMs(v) {
    const t = Date.parse(v?.created || "");
    return Number.isFinite(t) ? t : 0;
  }

  function setLatest(elValue, elMeta, item, fallbackText) {
    if (!item) {
      document.getElementById(elValue).textContent = fallbackText;
      document.getElementById(elMeta).textContent = "";
      return;
    }
    document.getElementById(elValue).innerHTML =
      `${escapeHtml(item.version)} ${item.stable ? '<span class="pill pill-strong">stable</span>' : ''}`;
    const meta = [];
    if (item.appVersion) meta.push(`App: ${item.appVersion}`);
    if (item.created) meta.push(item.created);
    document.getElementById(elMeta).textContent = meta.join(" • ");
  }

  function renderFromYamlText(yamlText) {
    let data;
    try {
      data = jsyaml.load(yamlText);
    } catch (e) {
      status("YAML konnte nicht gelesen werden: " + e.message, true);
      return;
    }

    const entries = data?.entries || {};
    const chartNames = Object.keys(entries);
    if (!chartNames.length) {
      status("Keine Charts im index.yaml gefunden.", true);
      return;
    }

    const chartName = entries[PREFERRED_CHART] ? PREFERRED_CHART : chartNames[0];
    const versions = entries[chartName] || [];

    const sorted = [...versions].sort((a,b) => {
      const db = dateMs(b), da = dateMs(a);
      if (db !== da) return db - da;
      return String(b.version).localeCompare(String(a.version), undefined, {numeric:true});
    });

    const allLines = sorted.map(v => ({
      version: v.version || "—",
      appVersion: v.appVersion || "",
      created: v.created || "",
      stable: isStable(v),
      ms: dateMs(v)
    }));

    const latestAny = allLines[0] || null;
    const latestStable = allLines.find(x => x.stable) || null;

    document.title = `Versionen – ${chartName}`;
    document.querySelector("h1").textContent = `Versionen: ${chartName}`;

    document.getElementById("asof").textContent = new Date().toLocaleString("de-DE");

    setLatest("latestAny", "latestAnyMeta", latestAny, "—");
    setLatest("latestStable", "latestStableMeta", latestStable, "Keine stable-Version gefunden");

    const listEl = document.getElementById("list");
    const qEl = document.getElementById("q");
    qEl.disabled = false;

    function render(filter="") {
      const f = filter.trim().toLowerCase();
      const filtered = allLines.filter(v => {
        if (!f) return true;
        if (f === "stable") return v.stable;
        return String(v.version).toLowerCase().includes(f)
          || String(v.appVersion).toLowerCase().includes(f);
      });

      listEl.innerHTML = filtered.map(v => {
        const stablePill = v.stable ? ` <span class="pill">stable</span>` : "";
        const app = v.appVersion ? `<span class="verMeta">App: ${escapeHtml(v.appVersion)}</span>` : "";
        return `<div class="verLine"><strong>${escapeHtml(v.version)}</strong>${stablePill}${app}</div>`;
      }).join("") || `<div class="muted">Keine Treffer.</div>`;

      listEl.style.display = "";
      status(`${filtered.length} Version(en) angezeigt.`);
    }

    qEl.oninput = (e) => render(e.target.value);
    render("");
  }

  async function loadOnline() {
    try {
      status("Lade Daten…");
      // Cache-Buster, damit Neu laden wirklich neu lädt
      const url = BASE_INDEX_URL + "?t=" + Date.now();
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const text = await res.text();
      renderFromYamlText(text);
    } catch (e) {
      status("Konnte Daten nicht online laden: " + e.message, true);
    }
  }

  document.getElementById("reload").addEventListener("click", loadOnline);

  // Automatisch beim Öffnen laden
  loadOnline();
})();
</script>
</body>
</html>
